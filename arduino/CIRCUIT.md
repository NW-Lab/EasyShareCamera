# 回路図：水滴検知トリガーシステム

## ⚠️ 重要：Neopixelの電圧レベルについて

Neopixel（WS2812B）は、**DIN信号電圧がVDD（電源電圧）の70%以上**である必要があります。

- **5V電源の場合**: DINは3.5V以上必要 → XIAO SAMD21の3.3V出力では**不安定**
- **3.3V電源の場合**: DINは2.31V以上必要 → XIAO SAMD21の3.3V出力で**確実に動作**

このため、以下の2つの構成を提案します。

---

## 構成A: 3.3V電源供給（推奨・最も簡単）

### 特徴
- ✅ 追加部品不要
- ✅ 確実に動作
- ✅ 配線がシンプル
- ⚠️ LEDの輝度が約70%（許容範囲）

### 回路図

```
フォトカプラ（PC817）
┌─────────────┐
│  1 Anode  ──┼─→ 赤外線LED（水滴検知用）
│  2 Cathode ──┼─→ GND
│  3 Emitter ──┼─→ GND
│  4 Collector─┼─→ XIAO D0（INPUT_PULLUP）
└─────────────┘

Seeed XIAO SAMD21
┌─────────────┐
│ D0  ←───────┼─ フォトカプラ Collector
│ D2  ────────┼─→ Neopixel DIN
│ 3.3V ───────┼─→ Neopixel VDD ★ 3.3V電源
│ GND ────────┼─→ Neopixel GND
└─────────────┘

Neopixel（8連）
┌──────────┐
│ DIN  ←───┼─ XIAO D2
│ VDD  ←───┼─ XIAO 3.3V ★ 3.3V電源
│ GND  ←───┼─ XIAO GND
└──────────┘
```

### ピン接続表

| XIAO SAMD21 | 接続先 | 備考 |
|---|---|---|
| D0 | フォトカプラ Collector | INPUT_PULLUP |
| D2 | Neopixel DIN | データ信号 |
| 3.3V | Neopixel VDD | ★ 3.3V電源 |
| GND | Neopixel GND, フォトカプラ Emitter | 共通GND |

### オプション: 個別LED（バックアップ）

必要に応じて、個別の赤色・白色LEDを追加できます。

```
XIAO D3 ─→ 220Ω抵抗 ─→ 赤色LED ─→ GND
XIAO D4 ─→ 220Ω抵抗 ─→ 白色LED ─→ GND
```

---

## 構成B: 5V電源 + レベルシフタ（最も確実・イベント用）

### 特徴
- ✅ 最も信頼性が高い
- ✅ LEDが最大輝度
- ✅ 長時間動作でも安定
- ⚠️ 追加部品が必要（74AHCT125: 100円程度）

### 必要部品

| 部品 | 型番 | 価格 | 購入先 |
|---|---|---|---|
| ロジックレベルシフタ | 74AHCT125 または 74HCT125 | 100円 | 秋月電子、千石電商 |

### 回路図

```
フォトカプラ（PC817）
┌─────────────┐
│  1 Anode  ──┼─→ 赤外線LED（水滴検知用）
│  2 Cathode ──┼─→ GND
│  3 Emitter ──┼─→ GND
│  4 Collector─┼─→ XIAO D0（INPUT_PULLUP）
└─────────────┘

Seeed XIAO SAMD21
┌─────────────┐
│ D0  ←───────┼─ フォトカプラ Collector
│ D2  ────────┼─→ 74AHCT125 1A
│ 5V  ────────┼─→ 74AHCT125 VCC, Neopixel VDD
│ GND ────────┼─→ 74AHCT125 GND, ~1OE, Neopixel GND
└─────────────┘

74AHCT125（レベルシフタ）
┌─────────────┐
│ VCC  ←──────┼─ XIAO 5V
│ 1A   ←──────┼─ XIAO D2（3.3V信号）
│ ~1OE ───────┼─→ GND（常に有効）
│ 1Y   ───────┼─→ Neopixel DIN（5V信号）
│ GND  ───────┼─→ XIAO GND
└─────────────┘

Neopixel（8連）
┌──────────┐
│ DIN  ←───┼─ 74AHCT125 1Y（5V信号）
│ VDD  ←───┼─ XIAO 5V
│ GND  ←───┼─ XIAO GND
└──────────┘
```

### ピン接続表

| XIAO SAMD21 | 74AHCT125 | Neopixel | 備考 |
|---|---|---|---|
| D0 | - | - | フォトカプラ入力 |
| D2 | 1A | - | 3.3V信号 |
| 5V | VCC | VDD | 電源 |
| GND | GND, ~1OE | GND | 共通GND |
| - | 1Y | DIN | 5V信号 |

### 74AHCT125のピン配置

```
    ┌─────┐
~1OE│1  14│VCC
 1A │2  13│~4OE
 1Y │3  12│4A
~2OE│4  11│4Y
 2A │5  10│~3OE
 2Y │6   9│3A
GND │7   8│3Y
    └─────┘
```

使用するピン:
- ピン14（VCC）: 5V
- ピン7（GND）: GND
- ピン1（~1OE）: GND（常に有効化）
- ピン2（1A）: XIAO D2
- ピン3（1Y）: Neopixel DIN

---

## フォトカプラの動作原理

### 水滴が通過していない時
- 赤外線LEDの光がフォトトランジスタに届く
- Collectorが導通（LOW）
- XIAO D0 = LOW

### 水滴が通過した時
- 水滴が光を遮る
- Collectorが非導通（HIGH）
- XIAO D0 = HIGH（INPUT_PULLUPにより）
- **トリガー発動！**

---

## Neopixel LED配置

### 推奨配置

```
LED 0-3: 赤色（カメラトリガー用）
LED 4-7: 白色（照明用）
```

### コード内での設定

```cpp
const int RED_LED_START = 0;
const int RED_LED_COUNT = 4;
const int WHITE_LED_START = 4;
const int WHITE_LED_COUNT = 4;
```

---

## どちらの構成を選ぶべきか？

| 用途 | 推奨構成 | 理由 |
|---|---|---|
| **テスト・学習** | 構成A（3.3V電源） | シンプルで確実 |
| **イベント・本番** | 構成B（レベルシフタ） | 最大輝度と信頼性 |
| **予算重視** | 構成A（3.3V電源） | 追加部品不要 |
| **輝度重視** | 構成B（レベルシフタ） | 5V電源で最大輝度 |

---

## 部品リスト

### 共通部品

| 部品 | 型番 | 数量 | 価格 | 購入先 |
|---|---|---|---|---|
| マイコン | Seeed XIAO SAMD21 | 1 | 1,000円 | 秋月電子、スイッチサイエンス |
| Neopixel | WS2812B 8連 | 1 | 500円 | Amazon、AliExpress |
| フォトカプラ | PC817 | 1 | 20円 | 秋月電子 |
| ブレッドボード | - | 1 | 300円 | 秋月電子 |
| ジャンパーワイヤ | - | 1セット | 200円 | 秋月電子 |

### 構成B追加部品

| 部品 | 型番 | 数量 | 価格 | 購入先 |
|---|---|---|---|---|
| レベルシフタ | 74AHCT125 | 1 | 100円 | 秋月電子、千石電商 |

---

## トラブルシューティング

### Neopixelが点灯しない

**構成A（3.3V電源）の場合**:
- 電源電圧を確認（3.3Vになっているか）
- DINの接続を確認
- Neopixelライブラリがインストールされているか確認

**構成B（レベルシフタ）の場合**:
- 74AHCT125のVCCが5Vになっているか確認
- ~1OEがGNDに接続されているか確認
- 74AHCT125のピン配置を再確認

### Neopixelが不安定

- 5V電源 + 3.3Vロジックを使用していませんか？
  → 構成Aまたは構成Bに変更してください
- 電源容量は十分ですか？（8個のLED: 最大480mA）
- 配線が長すぎませんか？（DIN信号線は30cm以内推奨）

### フォトカプラが反応しない

- 赤外線LEDが点灯しているか確認（スマホカメラで見ると見える）
- フォトカプラの向きを確認
- D0がINPUT_PULLUPに設定されているか確認
